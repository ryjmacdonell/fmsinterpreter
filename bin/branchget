#!/usr/bin/env python
"""
Command line script for matching a set of spawn geometries to a set of
reference geometries and outputting geometries and branching ratios.
"""
import os
import numpy as np
from geomtools import molecule
from geomtools import kabsch
from fmsinterpreter import fileio
from fmsinterpreter import branching
from fmsinterpreter import default


def main():
    """The main getbranch routine."""
    # read in inputs and set defaults
    inp = default.branchget
    fileio.cfg_update(inp, 'branch.inp')

    # get reference filenames
    ref_fnames = fileio.get_fnames(inp['ref_geoms'])

    # get test filenames
    test_fnames = fileio.get_fnames(inp['test_geoms'])

    # match tests onto refs
    matched = branching.branching(ref_fnames, test_fnames, inp['states'])

    # output matched geometries and summary file
    outdir = 'branch_s{:d}s{:d}'.format(*inp['states'])
    if not os.path.exists(outdir):
        os.makedirs(outdir)
    else:
        for fname in os.listdir(outdir):
            os.remove(outdir+'/'+fname)
    for bundle, fname in zip(matched, ref_fnames):
        if bundle.get_nmol() > 0:
            bundle.write(outdir+'/'+fname)


if __name__ == '__main__':
    main()
